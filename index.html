<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DepEd Class Schedule Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { color-scheme: light; }\
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .modal { transition: opacity .3s ease-in-out, visibility .3s ease-in-out; }
    .modal.hidden { opacity: 0; visibility: hidden; }
    .modal.visible { opacity: 1; visibility: visible; }

    /* Sticky first column in schedule tables */
    .sticky-col { position: sticky; left: 0; z-index: 10; background: white; }
    thead .sticky-col { z-index: 20; }
    thead.teacher-program th:first-child { z-index: 30; }

    /* Simple fade for views */
    .fade-in { animation: fade .25s ease-out both; }
    @keyframes fade { from { opacity: .0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="bg-white shadow-sm rounded-2xl px-6 py-4 mb-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-indigo-600/10 flex items-center justify-center">
          <span class="text-xl font-bold text-indigo-700">DG</span>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-800">DepEd Class Schedule Generator</h1>
          <p class="text-sm text-gray-500">Generate daily schedules from teacher assignments</p>
        </div>
      </div>
    </header>

    <!-- Stepper -->
    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 mb-6">
      <ol class="flex items-center w-full">
        <li class="flex items-center w-1/2" id="stepper-1">
          <span class="flex items-center justify-center w-8 h-8 mr-2 text-sm font-medium rounded-full bg-indigo-600 text-white">1</span>
          <span class="text-sm md:text-base font-medium">Set School Parameters</span>
          <span class="flex-auto border-t ml-2 border-gray-200"></span>
        </li>
        <li class="flex items-center w-1/2" id="stepper-2">
          <span class="flex items-center justify-center w-8 h-8 mr-2 text-sm font-medium rounded-full bg-gray-200 text-gray-700">2</span>
          <span class="text-sm md:text-base font-medium text-gray-500">Enter Teachers & Generate</span>
        </li>
      </ol>
    </div>

    <!-- Views Container -->
    <div class="bg-white rounded-2xl shadow-md p-4 md:p-6">
      <!-- Setup View: Select Program Level -->
      <section id="setup-view" class="fade-in">
        <h2 class="text-xl font-bold text-indigo-700 mb-4">Set School Parameters</h2>
        <div class="grid md:grid-cols-2 items-end gap-4">
          <div>
            <label for="programLevel" class="block text-gray-700 text-sm font-semibold mb-1">Select Program Level</label>
            <select id="programLevel" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="" disabled selected>Choose a Program Level</option>
              <option value="elementary">Elementary (Kinder - Grade 6)</option>
              <option value="jhs">Junior High School (Grades 7 - 10)</option>
              <option value="shs">Senior High School (Grades 11 - 12)</option>
            </select>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t">
          <h3 class="text-lg font-bold text-indigo-700 mb-4">Daily Schedule Periods</h3>
          <p class="text-sm text-gray-500 mb-4">Enter the time duration for each period. Recess and Lunch are fixed breaks.</p>
          <div id="time-duration-container" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4"></div>
        </div>

        <div class="flex items-center justify-end gap-3 mt-6">
          <button id="proceedToSectionsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-3 rounded-xl shadow">Continue</button>
        </div>
      </section>

      <!-- Sections View: Specify sections per grade -->
      <section id="sections-view" class="hidden fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-indigo-700">Sections per Grade</h2>
          <button id="backToSetupBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">Back</button>
        </div>
        <p class="text-sm text-gray-500 mb-4">Specify how many sections each grade level has. Letters (A, B, C…) will be auto-assigned.</p>
        <div id="sections-input-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <div class="flex items-center justify-end gap-3 mt-6">
          <button id="proceedToMainBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-3 rounded-xl shadow">Continue to Teacher Assignments</button>
        </div>
      </section>

      <!-- Main View -->
      <section id="main-view" class="hidden fade-in">
        <!-- Hidden original textarea to keep compatibility with existing parsing/saving logic -->
        <textarea id="teachersInput" rows="8" class="sr-only"></textarea>

        <div class="flex items-center justify-between gap-3 mb-4">
          <h2 class="text-xl font-bold text-indigo-700">Teacher Assignments</h2>
          <div class="flex items-center gap-2">
            <button id="backToSetupFromMainBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Back to Setup</button>
            <button id="importPasteBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Paste List</button>
            <button id="addRowBtn" class="px-3 py-2 rounded-lg bg-gray-800 text-white hover:bg-black">Add Row</button>
          </div>
        </div>

        <div class="overflow-x-auto border rounded-xl">
          <table class="min-w-full text-sm" id="teacherTable">
            <thead class="bg-gray-50 text-gray-700">
              <tr>
                <th class="p-3 text-left">Teacher Name</th>
                <th class="p-3 text-left">Subject</th>
                <th class="p-3 text-left">Grade</th>
                <th class="p-3 text-left">Section</th>
                <th class="p-3 text-center w-20">Actions</th>
              </tr>
            </thead>
            <tbody id="teacherTbody" class="divide-y"></tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">Tip: Use TAB to move across fields. Subjects and Grades have dropdowns to avoid typos.</p>

        <div class="flex flex-wrap items-center gap-3 mt-6">
          <button id="generateBtn" class="bg-gray-400 text-white font-bold px-5 py-3 rounded-xl shadow cursor-not-allowed">Generate Schedules</button>
        </div>

        <!-- Schedule tabs and content -->
        <div id="schedule-display" class="hidden fade-in mt-8">
            <div role="tablist" class="flex flex-col sm:flex-row gap-2 mb-4">
                <button role="tab" id="tab-school" class="tab-btn px-4 py-2 rounded-xl text-sm font-semibold bg-indigo-600 text-white">School-wide Schedule</button>
                <button role="tab" id="tab-teacher" class="tab-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-200 text-gray-700">Teacher's Program</button>
                <button role="tab" id="tab-class" class="tab-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gray-200 text-gray-700">Class Program</button>
            </div>

            <div id="school-schedule-container" class="tab-content">
                <div class="flex justify-end mb-4">
                    <button id="export-school-btn" class="px-4 py-2 rounded-xl border hover:bg-gray-50 text-sm">Export to CSV</button>
                </div>
            </div>

            <div id="teacher-program-container" class="tab-content hidden">
              <div class="flex justify-between items-center mb-4">
                <div class="max-w-sm w-full">
                  <label for="teacherSelector" class="block text-gray-700 text-sm font-semibold mb-1">Select a Teacher</label>
                  <select id="teacherSelector" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select a Teacher</option>
                  </select>
                </div>
                <button id="export-teacher-btn" class="px-4 py-2 rounded-xl border hover:bg-gray-50 text-sm">Export to CSV</button>
              </div>
              <div id="teacher-schedule-container" class="overflow-x-auto"></div>
            </div>

            <div id="class-program-container" class="tab-content hidden">
              <div class="flex justify-between items-center mb-4">
                <div class="max-w-sm w-full">
                  <label for="classSelector" class="block text-gray-700 text-sm font-semibold mb-1">Select a Class</label>
                  <select id="classSelector" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select a Class</option>
                  </select>
                </div>
                <button id="export-class-btn" class="px-4 py-2 rounded-xl border hover:bg-gray-50 text-sm">Export to CSV</button>
              </div>
              <div id="class-schedule-container" class="overflow-x-auto"></div>
            </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrapper" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Overlay Loader -->
  <div id="overlayLoader" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-40 hidden">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="w-12 h-12 border-4 border-gray-300 rounded-full border-t-transparent animate-spin"></div>
    </div>
  </div>

  <!-- Paste Modal -->
  <div id="pasteModal" class="modal fixed inset-0 flex items-center justify-center bg-black/50 hidden z-50">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-[95vw] max-w-2xl">
      <h3 class="text-lg font-bold mb-2">Paste Teacher List</h3>
      <p class="text-sm text-gray-600 mb-4">One record per line in the format: <span class="font-mono">Teacher Name, Subject, Grade Level, Section</span></p>
      <textarea id="pasteArea" class="w-full border rounded-lg p-3 h-48" placeholder="e.g.,&#10;Juan Dela Cruz, Mathematics, Grade 7, A&#10;Maria Santos, English, Grade 7, A"></textarea>
      <div class="flex items-center justify-end gap-3 mt-4">
        <button id="cancelPasteBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">Cancel</button>
        <button id="applyPasteBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Add to Table</button>
      </div>
    </div>
  </div>

  <!-- Message Modal (reused for warnings) -->
  <div id="messageModal" class="modal fixed inset-0 flex items-center justify-center bg-black/50 hidden z-50">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm mx-auto">
      <h3 id="modalTitle" class="text-lg font-bold mb-2 text-gray-900"></h3>
      <p id="modalMessage" class="text-sm text-gray-600 mb-6"></p>
      <div class="flex justify-end gap-2">
        <button id="closeModalBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- DOM refs ---
    const setupView = document.getElementById('setup-view');
    const sectionsView = document.getElementById('sections-view');
    const mainView = document.getElementById('main-view');
    const scheduleDisplay = document.getElementById('schedule-display');
    const programLevelSelect = document.getElementById('programLevel');
    const sectionsInputContainer = document.getElementById('sections-input-container');
    const timeDurationContainer = document.getElementById('time-duration-container');

    const teacherTable = document.getElementById('teacherTable');
    const teacherTbody = document.getElementById('teacherTbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const importPasteBtn = document.getElementById('importPasteBtn');

    const teachersInput = document.getElementById('teachersInput'); // hidden textarea (source of truth)

    const generateBtn = document.getElementById('generateBtn');

    const schoolScheduleContainer = document.getElementById('school-schedule-container');
    const teacherProgramContainer = document.getElementById('teacher-program-container');
    const teacherScheduleContainer = document.getElementById('teacher-schedule-container');
    const teacherSelector = document.getElementById('teacherSelector');
    const classProgramContainer = document.getElementById('class-program-container');
    const classScheduleContainer = document.getElementById('class-schedule-container');
    const classSelector = document.getElementById('classSelector');

    const exportSchoolBtn = document.getElementById('export-school-btn');
    const exportTeacherBtn = document.getElementById('export-teacher-btn');
    const exportClassBtn = document.getElementById('export-class-btn');

    const tabSchool = document.getElementById('tab-school');
    const tabTeacher = document.getElementById('tab-teacher');
    const tabClass = document.getElementById('tab-class');

    const proceedToSectionsBtn = document.getElementById('proceedToSectionsBtn');
    const proceedToMainBtn = document.getElementById('proceedToMainBtn');
    const backToSetupBtn = document.getElementById('backToSetupBtn');
    const backToSetupFromMainBtn = document.getElementById('backToSetupFromMainBtn');

    const pasteModal = document.getElementById('pasteModal');
    const pasteArea = document.getElementById('pasteArea');
    const cancelPasteBtn = document.getElementById('cancelPasteBtn');
    const applyPasteBtn = document.getElementById('applyPasteBtn');

    const messageModal = document.getElementById('messageModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeModalBtn = document.getElementById('closeModalBtn');

    const overlayLoader = document.getElementById('overlayLoader');
    const toastWrapper = document.getElementById('toastWrapper');

    const stepper1 = document.getElementById('stepper-1');
    const stepper2 = document.getElementById('stepper-2');

    // --- App state ---
    let schoolSchedule = null; // generated schedule object
    let currentGrades = []; // Grades based on selected program level
    let timeDurations = []; // Editable time durations for periods

    // Constants
    const subjects = [
      'Filipino','English','Mathematics','Science','Araling Panlipunan','MAPEH','TLE','Edukasyon sa Pagpapakatao'
    ];
    const subjectAbbreviations = { 'Math': 'Mathematics', 'AP': 'Araling Panlipunan', 'EsP': 'Edukasyon sa Pagpapakatao' };

    // --- UPDATED PERIOD ARRAYS based on user request ---
    const scheduleItems = ['1st Period', '2nd Period', 'Recess', '3rd Period', '4th Period', '5th Period', 'Lunch', '6th Period', '7th Period', '8th Period'];
    const periods = ['1st Period', '2nd Period', '3rd Period', '4th Period', '5th Period', '6th Period', '7th Period', '8th Period'];

    // Updated default time durations to match the new schedule items (10 total).
    const defaultTimeDurations = [
      '7:45 am - 8:35 am', '8:35 am - 9:25 am', '9:25 am - 10:15 am', '10:15 am - 10:30 am',
      '10:30 am - 11:20 am', '11:20 am - 12:10 pm', '12:10 pm - 1:00 pm', '1:00 pm - 1:50 pm',
      '1:50 pm - 2:40 pm', '2:40 pm - 3:30 pm'
    ];
    const gradeNames = ['Kinder','Grade 1','Grade 2','Grade 3','Grade 4','Grade 5','Grade 6','Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12'];
    const programGrades = {
      elementary: [0, 1, 2, 3, 4, 5, 6],
      jhs: [7, 8, 9, 10],
      shs: [11, 12]
    };
    const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

    // --- Utilities ---
    const showView = (elToShow) => {
      [setupView, sectionsView, mainView].forEach(el => el.classList.add('hidden'));
      elToShow.classList.remove('hidden');
      elToShow.classList.add('fade-in');
      updateStepper();
    };

    const updateStepper = () => {
      const step1Active = !setupView.classList.contains('hidden') || !sectionsView.classList.contains('hidden');
      stepper1.querySelector('span').className = `flex items-center justify-center w-8 h-8 mr-2 text-sm font-medium rounded-full ${step1Active ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`;
      stepper2.querySelector('span').className = `flex items-center justify-center w-8 h-8 mr-2 text-sm font-medium rounded-full ${mainView.classList.contains('hidden') ? 'bg-gray-200 text-gray-700' : 'bg-indigo-600 text-white'}`;
    };

    const updateGenerateButtonState = () => {
      const hasContent = teachersInput.value.trim() !== '';
      if (hasContent) {
        generateBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        generateBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        generateBtn.disabled = false;
      } else {
        generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        generateBtn.disabled = true;
      }
    };

    const switchTab = (tabName) => {
        const tabs = {
            'school': schoolScheduleContainer,
            'teacher': teacherProgramContainer,
            'class': classProgramContainer
        };

        // Reset all tab buttons and content
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Activate selected tab
        const selectedTabBtn = document.getElementById(`tab-${tabName}`);
        selectedTabBtn.classList.remove('bg-gray-200', 'text-gray-700');
        selectedTabBtn.classList.add('bg-indigo-600', 'text-white');
        tabs[tabName].classList.remove('hidden');
    };

    const toast = (msg, type = 'info') => {
      const colors = {
        info: 'bg-white border-blue-200',
        success: 'bg-white border-green-200',
        warning: 'bg-white border-yellow-200',
        error: 'bg-white border-red-200'
      };
      const el = document.createElement('div');
      el.className = `border ${colors[type]} shadow-sm rounded-xl px-4 py-3 text-sm text-gray-800 flex items-start gap-3`;
      el.innerHTML = `<div class="mt-0.5">${msg}</div>`;
      toastWrapper.appendChild(el);
      setTimeout(() => { el.classList.add('opacity-0'); el.style.transition='opacity .3s'; setTimeout(()=>el.remove(), 300); }, 2800);
    };

    const showMessageModal = (title, message) => { modalTitle.textContent = title; modalMessage.textContent = message; messageModal.classList.remove('hidden'); messageModal.classList.add('visible'); };
    const hideMessageModal = () => { messageModal.classList.remove('visible'); messageModal.classList.add('hidden'); };

    const showLoader = () => overlayLoader.classList.remove('hidden');
    const hideLoader = () => overlayLoader.classList.add('hidden');

    const shuffleArray = (array) => { const a=[...array]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };

    // Export function to download a table as CSV
    function exportTableToCsv(tableId, filename) {
      const table = document.getElementById(tableId);
      if (!table) {
          toast('Table not found for export.', 'error');
          return;
      }

      const rows = table.querySelectorAll('tr');
      const csv = [];
      for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const cols = row.querySelectorAll('th, td');
          const rowData = [];
          for (let j = 0; j < cols.length; j++) {
              const col = cols[j];
              let cellData = '';
              if (tableId === 'classProgramTable' && j > 0) {
                  // Special handling for class program to format Subject - Teacher
                  const subject = col.querySelector('.font-semibold');
                  const teacher = col.querySelector('.text-xs');
                  if (subject && teacher) {
                      cellData = `${subject.innerText.trim()} - ${teacher.innerText.trim()}`;
                  } else {
                      cellData = col.innerText.trim();
                  }
              } else {
                  cellData = col.innerText.trim();
              }
              // Replace newlines with a space for CSV formatting
              cellData = cellData.replace(/\s+/g, ' ');
              // Escape quotes
              cellData = cellData.replace(/"/g, '""');
              rowData.push(`"${cellData}"`);
          }
          csv.push(rowData.join(','));
      }

      const csvString = csv.join('\n');
      const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Time duration inputs
    function generateTimeDurationInputs() {
      timeDurationContainer.innerHTML = '';
      timeDurations = [];
      scheduleItems.forEach((item, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'w-full';
        const labelText = item;
        const inputType = 'text';
        const inputClass = `w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500`;
        const inputValue = defaultTimeDurations[index] || '';

        wrapper.innerHTML = `
          <label class="block text-gray-700 text-sm font-semibold mb-1">${labelText}</label>
          <input type="${inputType}" value="${inputValue}" data-period="${item}" class="${inputClass}" />`;
        timeDurationContainer.appendChild(wrapper);
      });
      getTimeDurationsFromInputs();
    }

    function getTimeDurationsFromInputs() {
      const inputs = timeDurationContainer.querySelectorAll('input');
      timeDurations = [...inputs].map(input => input.value.trim());
    }

    // Sections inputs
    function generateSectionsInputs() {
      sectionsInputContainer.innerHTML = '';
      const selectedLevel = programLevelSelect.value;
      if (!selectedLevel) return;
      currentGrades = programGrades[selectedLevel];
      currentGrades.forEach(gradeIdx => {
        const wrapper = document.createElement('div');
        wrapper.className = 'w-full';
        wrapper.innerHTML = `
          <label class="block text-gray-700 text-sm font-semibold mb-1">Sections for ${gradeNames[gradeIdx]}</label>
          <input type="number" min="1" value="1" data-grade="${gradeIdx}" class="section-count w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />`;
        sectionsInputContainer.appendChild(wrapper);
      });
    }

    function getSectionsConfig() {
      const config = {};
      const inputs = sectionsInputContainer.querySelectorAll('.section-count');
      inputs.forEach(input => {
        const grade = input.getAttribute('data-grade');
        const sections = Math.max(1, parseInt(input.value) || 1);
        config[grade] = sections;
      });
      return config;
    }

    // Teacher table helpers
    function makeSubjectSelect(value = '') {
      const sel = document.createElement('select');
      sel.className = 'w-full border rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      sel.innerHTML = `<option value="">Select</option>` + subjects.map(s=>`<option ${s===value?'selected':''}>${s}</option>`).join('');
      return sel;
    }
    function makeGradeSelect(value = '') {
      const sel = document.createElement('select');
      sel.className = 'w-full border rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      const gradeOptions = currentGrades.map(gradeIdx => `<option value="${gradeIdx}" ${String(gradeIdx) === String(value) ? 'selected' : ''}>${gradeNames[gradeIdx]}</option>`).join('');
      sel.innerHTML = `<option value="">Select</option>` + gradeOptions;
      return sel;
    }
    function addTeacherRow({name='', subject='', grade='', section=''}={}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2"><input type="text" class="w-full border rounded-lg px-2 py-1.5" placeholder="Teacher name" value="${name}"></td>
        <td class="p-2"></td>
        <td class="p-2"></td>
        <td class="p-2"><input type="text" class="w-full border rounded-lg px-2 py-1.5" placeholder="Section (e.g., A)" value="${section}"></td>
        <td class="p-2 text-center"><button class="text-red-600 hover:underline remove-row">Remove</button></td>`;
      const subjectCell = tr.children[1];
      const gradeCell = tr.children[2];
      subjectCell.appendChild(makeSubjectSelect(subject));
      gradeCell.appendChild(makeGradeSelect(grade));
      teacherTbody.appendChild(tr);
    }

    function tableToTextarea() {
      const rows = [...teacherTbody.querySelectorAll('tr')];
      const lines = rows.map(tr => {
        const name = tr.children[0].querySelector('input').value.trim();
        const subject = tr.children[1].querySelector('select').value.trim();
        const gradeIdx = tr.children[2].querySelector('select').value;
        const section = tr.children[3].querySelector('input').value.trim();
        if (!name && !subject && !gradeIdx && !section) return '';
        const gradeLabel = gradeIdx===''?'' : (gradeIdx==0 ? 'Kinder' : 'Grade '+gradeIdx);
        return `${name}, ${subject}, ${gradeLabel}, ${section}`;
      }).filter(Boolean);
      teachersInput.value = lines.join('\n');
      updateGenerateButtonState();
    }

    function textareaToTable() {
      teacherTbody.innerHTML='';
      const lines = teachersInput.value.trim().split('\n').filter(l=>l.trim()!=='' && !l.trim().startsWith('//'));
      lines.forEach(line => {
        const parts = line.split(',').map(p=>p.trim());
        const [name, subjRaw, gradeRaw, section] = [parts[0]||'', parts[1]||'', parts[2]||'', parts[3]||''];
        const subject = subjectAbbreviations[subjRaw] || subjRaw;
        let gradeIdx = '';
        if (/^kinder$/i.test(gradeRaw)) gradeIdx = 0; else {
          const m = gradeRaw.match(/(\d+)/); gradeIdx = m? Number(m[1]) : '';
        }
        addTeacherRow({ name, subject, grade: gradeIdx, section });
      });
      updateGenerateButtonState();
    }

    // Parse teachers (re-uses original format)
    function parseTeachers() {
      tableToTextarea();
      const lines = teachersInput.value.trim().split('\n').filter(l=>l.trim()!=='' && !l.trim().startsWith('//'));
      const teachers = []; const invalidLines = [];
      lines.forEach((line, index) => {
        const parts = line.split(',').map(part => part.trim());
        if (parts.length === 4) {
          const gradeString = parts[2].replace(/Grade\s*/, '');
          const gradeNumber = gradeString.toLowerCase() === 'kinder' ? 0 : parseInt(gradeString);
          const subjectName = subjectAbbreviations[parts[1]] || parts[1];
          if (subjects.includes(subjectName) && !isNaN(gradeNumber) && parts[3]) {
            teachers.push({ name: parts[0], subject: subjectName, grade: gradeNumber, section: parts[3] });
          } else { invalidLines.push(`Line ${index + 1}: "${line}" - Invalid subject, grade, or section.`); }
        } else { invalidLines.push(`Line ${index + 1}: "${line}" - Expected 4 comma-separated values.`); }
      });
      return { teachers, invalidLines };
    }

    // Schedule generation
    function generateAndRenderSchoolSchedule() {
      schoolScheduleContainer.innerHTML = '';
      const { teachers, invalidLines } = parseTeachers();
      if (invalidLines.length) {
        schoolScheduleContainer.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl mb-4">
            <div class="font-semibold">Invalid Teacher Data</div>
            <ul class="list-disc ml-5 mt-1 text-sm">${invalidLines.map(l=>`<li>${l}</li>`).join('')}</ul>
          </div>`;
        return;
      }
      if (!teachers.length) {
        schoolScheduleContainer.innerHTML = '<p class="text-center text-red-500 font-semibold">Please enter valid teacher data to generate a schedule.</p>';
        return;
      }

      scheduleDisplay.classList.remove('hidden');

      // Build class assignments map
      const classAssignments = new Map();
      teachers.forEach(t => {
        const classKey = `${gradeNames[t.grade]}-${t.section}`;
        if (!classAssignments.has(classKey)) classAssignments.set(classKey, []);
        classAssignments.get(classKey).push({ subject: t.subject, teacher: t.name });
      });

      const allSchedules = {}; // { classKey: { periodName: {subject, teacher} } }
      const periodAvailability = new Map(); // period -> Set(teacher)
      periods.forEach(p => periodAvailability.set(p, new Set()));

      // Sort class keys by grade number then by section letter
      const classKeys = [...classAssignments.keys()].sort((a, b) => {
        const parseKey = (key) => {
          const [gradeStr, section] = key.split('-');
          const gradeNum = parseInt(gradeStr.replace('Grade ', '')) || 0;
          return { grade: gradeNum, section };
        };
        const keyA = parseKey(a);
        const keyB = parseKey(b);
        if (keyA.grade !== keyB.grade) return keyA.grade - keyB.grade;
        return keyA.section.localeCompare(keyB.section);
      });

      classKeys.forEach(classKey => {
        allSchedules[classKey] = {};
        const assignments = shuffleArray(classAssignments.get(classKey));
        let idx = 0;
        scheduleItems.forEach(item => {
          if (item === 'Recess' || item === 'Lunch') { allSchedules[classKey][item] = { subject: item.toUpperCase(), teacher: '' }; return; }
          let assigned = false, attempts = 0, max = assignments.length;
          while (!assigned && attempts < max) {
            const current = assignments[idx];
            const busy = periodAvailability.get(item);
            if (!busy.has(current.teacher)) {
              allSchedules[classKey][item] = { ...current };
              busy.add(current.teacher);
              const moved = assignments.splice(idx, 1)[0]; assignments.push(moved); idx = 0; assigned = true;
            } else { idx = (idx + 1) % assignments.length; attempts++; }
          }
          if (!assigned) allSchedules[classKey][item] = { subject: 'Unassigned', teacher: 'N/A' };
        });
      });

      schoolSchedule = allSchedules;

      // Get a unique list of all teachers
      const allTeachers = new Set(teachers.map(t => t.name));

      // Render School-wide table
      const table = document.createElement('table');
      table.id = 'schoolWideTable';
      table.className = 'min-w-full bg-white rounded-xl overflow-hidden shadow border';
      const thead = document.createElement('thead');
      thead.className = 'bg-indigo-600 text-white text-xs uppercase tracking-wide';
      const headRow = document.createElement('tr');
      headRow.innerHTML = `<th class="py-3 px-4 text-left sticky-col">TIME</th>` +
        [...classKeys].map(c => {
          const [grade, section] = c.split('-');
          return `<th class="py-3 px-4 text-center"><div class="font-semibold">${grade}</div><div class="font-normal text-xs uppercase">${section}</div></th>`;
        }).join('') +
        `<th class="py-3 px-4 text-center">Vacant Teachers</th>`;
      thead.appendChild(headRow);

      const tbody = document.createElement('tbody');
      tbody.className = 'text-gray-700 text-sm';

      scheduleItems.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
        const tdLabel = document.createElement('td');
        tdLabel.className = 'py-3 px-4 font-medium sticky-col';
        tdLabel.textContent = timeDurations[i];
        tr.appendChild(tdLabel);

        classKeys.forEach(classKey => {
          const a = allSchedules[classKey][item];
          const td = document.createElement('td');
          td.className = 'py-3 px-4 text-center';
          if (item === 'Recess' || item === 'Lunch') {
            td.innerHTML = `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">${item.toUpperCase()}</span>`;
          } else {
            const teacherTitle = a?.teacher && a.teacher !== 'N/A' ? `title="${a.teacher}"` : '';
            td.innerHTML = `
              <div class="font-semibold">${a?.subject || 'N/A'}</div>
              <div class="text-xs text-gray-500" ${teacherTitle}>${a?.teacher || 'N/A'}</div>`;
            if (a?.subject === 'Unassigned') td.classList.add('bg-yellow-50');
          }
          tr.appendChild(td);
        });

        const vacantCell = document.createElement('td');
        vacantCell.className = 'py-3 px-4 text-center text-xs text-gray-600';
        if (item === 'Recess' || item === 'Lunch') {
            vacantCell.innerHTML = '';
        } else {
            const busyTeachers = periodAvailability.get(item);
            const vacantTeachers = [...allTeachers].filter(t => !busyTeachers.has(t));
            vacantCell.innerHTML = vacantTeachers.length > 0 ? vacantTeachers.join('<br>') : 'None';
        }
        tr.appendChild(vacantCell);

        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      schoolScheduleContainer.appendChild(table);

      const unassignedCount = Object.values(allSchedules).flatMap(Object.values).filter(a=>a.subject==='Unassigned').length;
      if (unassignedCount>0) {
        const warn = document.createElement('div');
        warn.className = 'mt-3 bg-yellow-50 border border-yellow-200 text-yellow-900 px-4 py-3 rounded-xl';
        warn.innerHTML = `<strong>Heads up:</strong> A full schedule could not be generated. Ensure enough unique subject–teacher assignments to cover all periods.`;
        schoolScheduleContainer.prepend(warn);
      }

      populateTeacherSelector(teachers);
      populateClassSelector(classKeys);
    }

    function populateTeacherSelector(teachers) {
      teacherSelector.innerHTML = '<option value="">Select a Teacher</option>';
      [...new Set(teachers.map(t=>t.name))].sort().forEach(name => {
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name; teacherSelector.appendChild(opt);
      });
    }

    function populateClassSelector(classKeys) {
      classSelector.innerHTML = '<option value="">Select a Class</option>';
      const sortedKeys = classKeys.sort((a, b) => {
        const parseKey = (key) => {
          const [gradeStr, section] = key.split('-');
          const gradeNum = parseInt(gradeStr.replace('Grade ', '')) || 0;
          return { grade: gradeNum, section };
        };
        const keyA = parseKey(a);
        const keyB = parseKey(b);
        if (keyA.grade !== keyB.grade) return keyA.grade - keyB.grade;
        return keyA.section.localeCompare(keyB.section);
      });

      sortedKeys.forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        classSelector.appendChild(opt);
      });
    }

    function displaySelectedTeacherSchedule(teacherName) {
      teacherScheduleContainer.innerHTML = '';
      if (!teacherName) return;
      const teacherProgram = {}; scheduleItems.forEach(p=>teacherProgram[p] = { subject: 'Vacant', grade: '', section: '' });
      if (schoolSchedule) {
        for (const classKey in schoolSchedule) {
          for (const periodName in schoolSchedule[classKey]) {
            if (schoolSchedule[classKey][periodName].teacher === teacherName) {
              const [grade, section] = classKey.split('-');
              teacherProgram[periodName] = { subject: schoolSchedule[classKey][periodName].subject, grade, section };
            }
          }
        }
      }
      const table = document.createElement('table');
      table.id = 'teacherProgramTable';
      table.className = 'min-w-full bg-white rounded-xl overflow-hidden shadow border';
      const thead = document.createElement('thead');
      thead.className = 'bg-indigo-600 text-white text-xs uppercase tracking-wide teacher-program';
      thead.innerHTML = `<tr><th class="py-3 px-4 text-left sticky-col">TIME</th><th class="py-3 px-4 text-center">Subject</th><th class="py-3 px-4 text-center">Grade & Section</th></tr>`;
      const tbody = document.createElement('tbody'); tbody.className = 'text-gray-700 text-sm';
      scheduleItems.forEach((item, i)=>{
        const a = teacherProgram[item];
        const tr = document.createElement('tr'); tr.className = i%2===0?'bg-gray-50':'bg-white';
        tr.innerHTML = `<td class="py-3 px-4 font-medium sticky-col">${timeDurations[i]}</td>`;
        if (item === 'Recess' || item === 'Lunch') {
          tr.innerHTML += `<td colspan="2" class="py-3 px-4 text-center bg-gray-100 font-semibold text-gray-700">BREAK</td>`;
        } else {
          tr.innerHTML += `<td class="py-3 px-4 text-center">${a.subject}</td><td class="py-3 px-4 text-center">${a.grade ? `${a.grade}-${a.section}` : ''}</td>`;
        }
        tbody.appendChild(tr);
      });
      table.appendChild(thead); table.appendChild(tbody); teacherScheduleContainer.appendChild(table);
    }

    function displaySelectedClassSchedule(classKey) {
        classScheduleContainer.innerHTML = '';
        if (!classKey) return;

        const dailySchedule = schoolSchedule[classKey];
        if (!dailySchedule) {
            classScheduleContainer.innerHTML = `<p class="p-4 text-red-500">No schedule found for this class.</p>`;
            return;
        }

        const table = document.createElement('table');
        table.id = 'classProgramTable';
        table.className = 'min-w-full bg-white rounded-xl overflow-hidden shadow border';
        const thead = document.createElement('thead');
        thead.className = 'bg-indigo-600 text-white text-xs uppercase tracking-wide';
        const headRow = document.createElement('tr');
        headRow.innerHTML = `<th class="py-3 px-4 text-left sticky-col">TIME</th>` +
            daysOfWeek.map(day => `<th class="py-3 px-4 text-center">${day}</th>`).join('');
        thead.appendChild(headRow);

        const tbody = document.createElement('tbody');
        tbody.className = 'text-gray-700 text-sm';

        scheduleItems.forEach((item, i) => {
            const tr = document.createElement('tr');
            tr.className = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
            const tdLabel = document.createElement('td');
            tdLabel.className = 'py-3 px-4 font-medium sticky-col';
            tdLabel.textContent = timeDurations[i];
            tr.appendChild(tdLabel);

            daysOfWeek.forEach(day => {
                const a = dailySchedule[item];
                const td = document.createElement('td');
                td.className = 'py-3 px-4 text-center';
                if (item === 'Recess' || item === 'Lunch') {
                    td.innerHTML = `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">${item.toUpperCase()}</span>`;
                } else {
                    const teacherTitle = a?.teacher && a.teacher !== 'N/A' ? `title="${a.teacher}"` : '';
                    td.innerHTML = `
                      <div class="font-semibold">${a?.subject || 'N/A'}</div>
                      <div class="text-xs text-gray-500" ${teacherTitle}>${a?.teacher || 'N/A'}</div>`;
                    if (a?.subject === 'Unassigned') td.classList.add('bg-yellow-50');
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(thead); table.appendChild(tbody);
        classScheduleContainer.appendChild(table);
    }

    // Event listeners
    window.onload = () => {
      showView(setupView);
      generateTimeDurationInputs();
      updateGenerateButtonState();
    };

    timeDurationContainer.addEventListener('input', () => {
      getTimeDurationsFromInputs();
    });

    proceedToSectionsBtn.addEventListener('click', () => {
      if (programLevelSelect.value === '') {
        toast('Please select a program level to continue.', 'warning');
        return;
      }
      generateSectionsInputs();
      showView(sectionsView);
    });

    proceedToMainBtn.addEventListener('click', () => {
      const sectionsConfig = getSectionsConfig();
      let placeholderLines = [];
      for (const grade in sectionsConfig) {
        const count = sectionsConfig[grade];
        for (let j=1;j<=count;j++) {
          const letter = String.fromCharCode('A'.charCodeAt(0) + j - 1);
          placeholderLines.push(`// Enter teachers for ${gradeNames[grade]}, Section ${letter}`);
        }
      }
      teachersInput.value = placeholderLines.join('\n');
      textareaToTable();
      showView(mainView);
      toast('Now add teacher assignments, then click Generate.', 'info');
    });

    backToSetupBtn.addEventListener('click', () => {
      showView(setupView);
    });

    backToSetupFromMainBtn.addEventListener('click', () => {
        showView(setupView);
        teachersInput.value = '';
        teacherTbody.innerHTML = '';
        programLevelSelect.value = '';
        sectionsInputContainer.innerHTML = '';
        schoolScheduleContainer.innerHTML = '';
        scheduleDisplay.classList.add('hidden');
        schoolSchedule = null;
        updateGenerateButtonState();
    });

    programLevelSelect.addEventListener('change', () => {
      sectionsInputContainer.innerHTML = '';
    });

    generateBtn.addEventListener('click', async () => {
      showLoader();
      try { generateAndRenderSchoolSchedule(); }
      finally { hideLoader(); }
    });

    teacherSelector.addEventListener('change', (e) => displaySelectedTeacherSchedule(e.target.value));
    classSelector.addEventListener('change', (e) => displaySelectedClassSchedule(e.target.value));

    // Tab button event listeners
    tabSchool.addEventListener('click', () => switchTab('school'));
    tabTeacher.addEventListener('click', () => switchTab('teacher'));
    tabClass.addEventListener('click', () => switchTab('class'));

    // Export button event listeners
    exportSchoolBtn.addEventListener('click', () => {
        exportTableToCsv('schoolWideTable', 'School-wide_Schedule.csv');
    });
    exportTeacherBtn.addEventListener('click', () => {
        const teacherName = teacherSelector.value;
        if (teacherName) {
            exportTableToCsv('teacherProgramTable', `${teacherName}_Program.csv`);
        } else {
            toast('Please select a teacher first.', 'warning');
        }
    });
    exportClassBtn.addEventListener('click', () => {
        const classKey = classSelector.value;
        if (classKey) {
            exportTableToCsv('classProgramTable', `${classKey}_Program.csv`);
        } else {
            toast('Please select a class first.', 'warning');
        }
    });

    // Teacher table actions
    addRowBtn.addEventListener('click', () => {
      addTeacherRow();
      tableToTextarea();
    });
    teacherTbody.addEventListener('click', (e) => {
      if (e.target.closest('.remove-row')) {
        e.target.closest('tr').remove();
        tableToTextarea();
      }
    });
    teacherTbody.addEventListener('change', tableToTextarea);
    teacherTbody.addEventListener('input', tableToTextarea);

    // Paste modal
    importPasteBtn.addEventListener('click', ()=>{ pasteArea.value=''; pasteModal.classList.remove('hidden'); pasteModal.classList.add('visible'); });
    cancelPasteBtn.addEventListener('click', ()=>{ pasteModal.classList.remove('visible'); pasteModal.classList.add('hidden'); });
    applyPasteBtn.addEventListener('click', ()=>{
      const lines = pasteArea.value.split('\n').filter(Boolean);
      if (!lines.length) { toast('Nothing to add.', 'warning'); return; }
      lines.forEach(l=>{ teachersInput.value += (teachersInput.value? '\n':'') + l; });
      textareaToTable();
      toast('Pasted rows added.', 'success');
      pasteModal.classList.remove('visible'); pasteModal.classList.add('hidden');
    });

    // Message modal close
    closeModalBtn.addEventListener('click', hideMessageModal);
  </script>
</body>
</html>
